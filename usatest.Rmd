---
title: "Usagetest of new gazepath update"
author: "Helio"
date: "2024-07-03"
output: html_document
---


```{r}
# takes too long
# why do i ned to do this below to avoid errors in the gazath
dta_4gazepath_stim<- as.data.frame(as.matrix(dta_4gazepath_stim))
# 
# dta_4gazepath_stim1$left_gaze_x_cor_pix<- as.numeric(dta_4gazepath_stim1$left_gaze_x_cor_pix)
# dta_4gazepath_stim1$left_gaze_y_cor_pix<- as.numeric(dta_4gazepath_stim1$left_gaze_y_cor_pix)
# dta_4gazepath_stim1$right_gaze_x_cor_pix<- as.numeric(dta_4gazepath_stim1$right_gaze_x_cor_pix)
# dta_4gazepath_stim1$right_gaze_y_cor_pix<- as.numeric(dta_4gazepath_stim1$right_gaze_y_cor_pix)
# dta_4gazepath_stim1$distance_mm<- as.numeric(dta_4gazepath_stim1$distance_mm)


# Convert relevant columns to numeric
colnames(dta_4gazepath_stim)

dta_4gazepath_stim
dta_4gazepath_stim[, c(17, 18, 19, 20, 23, 28)] <- lapply(dta_4gazepath_stim[, c(17, 18, 19, 20, 23, 28)], as.numeric)

dta_4gazepath_stim$trial_no<- as.factor(dta_4gazepath_stim$trial_no)
unique(dta_4gazepath_stim$trial_no)



dta_140<- dta_4gazepath_stim%>%
  subset(ssid =="140")

dta_142<- dta_4gazepath_stim%>%
  subset(ssid =="142")

library(zoo)


unique(dta_142$trial_no)

unique(dta_140$text)
# dta_4gazepath_stim1




library(gazepath)
library(dplyr)

# Split the data by participant
tmp_stim_by_pp <- split(dta_4gazepath_stim, dta_4gazepath_stim$participant)





# Initialize an empty list to store gazepath results
gazepath_results <- list()

# Initialize an empty dataframe to store summary results
gp_summary_results <- data.frame()
# tmp_stim_by_pp$`208`
# Loop through each participant's data
for (participant_id in names(tmp_stim_by_pp)) {
  # Get the data for the current participant
  # dta <- tmp_stim_by_pp[[209]]
  dta <- tmp_stim_by_pp[[participant_id]]
  # Check if the trial column exists and has values
  # dta$trial_no
  if (!"trial_no" %in% colnames(dta) || all(is.na(dta$trial_no))) {
    warning(paste("Skipping participant", participant_id, "due to missing or empty 'trial' column"))
    next
  }
  
  # Ensure the trial column is properly formatted
  dta$trial_no <- as.factor(as.numeric(as.character(dta$trial_no)))
  
  # Run the gazepath analysis
  rslt_gp_stim <- gazepath(dta, 
                           x1 = 17, y1 = 19, 
                           x2 = 18, y2 = 20,
                           d1 = 23, d2 = 23,
                           trial = 28, # Ensure this is a character or factor
                           height_px = 1080, height_mm = 295,
                           width_px = 1920, width_mm = 525,
                           extra_var = c("text", "trial_no", "trial_no_gpid_stim", "stimnopath_no_na", "participant"),
                           method = 'gazepath',
                           samplerate = 150)
  
  # Append the gazepath result to the list
  gazepath_results[[participant_id]] <- rslt_gp_stim
  
  # Run the summary analysis
  rslt_fix_sacc_gp <- summary.gazepath(rslt_gp_stim)
  
  # Bind the summary results into the dataframe
  gp_summary_results <- bind_rows(gp_summary_results, rslt_fix_sacc_gp)
}

# Save gazepath results to an RDS file
saveRDS(gazepath_results, "gazepath_results.rds")

saveRDS(gp_summary_results, "gp_summary_results.rds")



tmp_stim_by_pp$`140`%>%
  subset(trial_no == 6)%>%
  ggplot(aes(as.numeric(timerezero), as.numeric(gaze_x_cor_pix)))+
  geom_line()+
  geom_line(aes(y = as.numeric(gaze_y_cor_pix)))


plot.gazepath(gazepath_results$`140`, trial_index = 6)


tmp_stim_by_pp$`208`%>%
  subset(trial_no == 6)%>%
  ggplot(aes(as.numeric(timerezero), as.numeric(gaze_x_cor_pix)))+
  geom_line()+
  geom_line(aes(y = as.numeric(gaze_y_cor_pix)))


plot.gazepath(gazepath_results$`208`, trial_index = 6)


```

```{r}

ppt140 <- gazepath(dta_140, 
                   x1 = 17, y1 = 19, 
                   x2 = 18, y2 = 20,
                   d1 = 23, d2 = 23,
                   trial = 28, # Ensure this is a character or factor
                   height_px = 1080, height_mm = 295,
                   width_px = 1920, width_mm = 525,
                   extra_var = c( "text","trial_no","trial_no_gpid_stim","stimnopath_no_na","participant"),
              
                   #rror in data.frame(simple, extra[i]) : 
                   # arguments imply differing number of rows: 345, 0 
                   # is related to etxra var
                   method = 'gazepath',
                   samplerate = 150)




gp_ppt140<- summary.gazepath(ppt140)
plot.gazepath(gp_ppt140, trial_index = 64)

dta_208<- dta_4gazepath_stim%>%
  subset(ssid == 208)
unique(dta_208$trial_no)


dta_208$trial_no<- as.factor(as.numeric(as.character(dta_208$trial_no)))

ppt208 <- gazepath(dta_208, 
                   x1 = 17, y1 = 19, 
                   x2 = 18, y2 = 20,
                   d1 = 23, d2 = 23,
                   trial = 28, # Ensure this is a character or factor
                   height_px = 1080, height_mm = 295,
                   width_px = 1920, width_mm = 525,
                   extra_var = c( "text","trial_no","trial_no_gpid_stim","stimnopath_no_na","participant"),
              
                   #rror in data.frame(simple, extra[i]) : 
                   # arguments imply differing number of rows: 345, 0 
                   # is related to etxra var
                   method = 'gazepath',
                   samplerate = 150)


```



dta_140%>%
  # subset(as.numeric(trial_no)>56)%>%
  ggplot(aes(trial_no, gaze_valid_prop))+
  geom_point()

```{r}
dta_140%>%
  subset(as.numeric(trial_no)==24)%>%
  ggplot(aes(as.numeric(timerezero), as.numeric(gaze_x_cor_pix)))+
  geom_line()+
  geom_line(aes(y = as.numeric(gaze_y_cor_pix)))

unique(dta_4gazepath_stim$trial_no)


tmp_208<- dta_4gazepath_stim%>%
  subset(ssid == 208)


unique(tmp_208$trial_no)

dta_4gazepath_stim%>%
  subset(ssid == 208)%>%
  subset(as.numeric(trial_no)==47) %>%
  ggplot(aes(as.numeric(timerezero), as.numeric(gaze_x_cor_pix)))+
  geom_line()+
  geom_line(aes(y = as.numeric(gaze_y_cor_pix)))



dta_4gazepath_stim%>%
  subset(ssid == 208)%>%
  # subset(as.numeric(trial_no)==20)%>%
  ggplot(aes(as.numeric(trial_no), as.numeric(gaze_valid_prop)))+
  geom_point()
  ggplot(aes(as.numeric(timerezero), as.numeric(gaze_x_cor_pix)))+
  geom_line()+
  geom_line(aes(y = as.numeric(gaze_y_cor_pix)))



```

plot.gazepath(ppt140, trial_index = 24)

plot.gazepath(ppt142, trial_index = 64)

# Checked multiple trials and seems to be working, but a few trials have unexpectedly long durations, likely due to issues with collection, so we should filter these at some point.


```


dta_140%>%
  subset(as.numeric(trial_no)==59)%>%
  ggplot(aes(as.numeric(timerezero), as.numeric(gaze_x_cor_pix)))+
  geom_line()+
  geom_line(aes(y = as.numeric(gaze_y_cor_pix)))


dta_140$text[dta_140$trial_no == 59]
# "tStart_stim_2580.jpg_IAPS_54



```{r}
gp_ppt140<- summary.gazepath(ppt140)

colnames(gp_ppt140)
# "tStart_stim_2580.jpg_IAPS_54
unique(gp_ppt140$text)

gp_ppt140$text[gp_ppt140$Trial == 6]
gp_ppt140$text[gp_ppt140$Trial == 60]

unique(gp_ppt140$trial_no)

unique(gp_ppt140$participant)
unique(gp_ppt140$Trial)
unique(gp_ppt140$trial_no_gpid_stim)

gp_ppt140$trial_no_gpid_stim

unique(gp_ppt140$Trial)

gp_ppt140%>%subset(Trial== 60)
```


```{r}
# dta_142$text<- as.character(dta_142$text)
# dta_142$trial_no_gpid_stim<- as.character(dta_142$trial_no_gpid_stim)
# dta_142$trial_no<- as.character(dta_142$trial_no)
# dta_142$stimnopath_no_na<- as.character(dta_142$stimnopath_no_na)
# dta_142$participant<- as.character(dta_142$participant)

ppt142 <- gazepath(dta_142, 
                   x1 = 17, y1 = 19, 
                   x2 = 18, y2 = 20,
                   d1 = 23, d2 = 23,
                   trial = 28, # Ensure this is a character or factor
                   height_px = 1080, height_mm = 295,
                   width_px = 1920, width_mm = 525,
                   extra_var = c("text","trial_no_gpid_stim","trial_no","stimnopath_no_na","participant"),
                   method = 'gazepath',
                   samplerate = 150)




gp_ppt142<- summary.gazepath(ppt142)

unique(gp_ppt142$text)

unique(gp_ppt142$participant)
unique(gp_ppt142$stimnopath_no_na)


gp_ppt142$text[gp_ppt142$Trial == 5]
gp_ppt142$stimnopath_no_na



dta_142%>%
  subset(as.numeric(trial_no)==64)%>%
  ggplot(aes(as.numeric(timerezero), as.numeric(gaze_x_cor_pix)))+
  geom_line()+
  geom_line(aes(y = as.numeric(gaze_y_cor_pix)))


plot.gazepath(ppt142, trial_index = 64)

# Checked multiple trials and seems to be working, but a few trials have unexpectedly long durations, likely due to issues with collection, so we should filter these at some point.




```

TO DO
<!-- check the issues with formating of the data and having to create a matrix of the datset -->
<!-- check the cumsum? why> -->






